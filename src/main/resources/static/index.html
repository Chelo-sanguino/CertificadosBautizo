<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema Parroquial</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        
        body { 
            display: flex; 
            min-height: 100vh; 
            background-color: #f4f6f9;
        }

        /* PERSONALIZACIÓN DEL CALENDARIO (Para que sea morado) */
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange, .flatpickr-day.selected.inRange, .flatpickr-day.startRange.inRange, .flatpickr-day.endRange.inRange, .flatpickr-day.selected:focus, .flatpickr-day.startRange:focus, .flatpickr-day.endRange:focus, .flatpickr-day.selected:hover, .flatpickr-day.startRange:hover, .flatpickr-day.endRange:hover, .flatpickr-day.selected.prevMonthDay, .flatpickr-day.startRange.prevMonthDay, .flatpickr-day.endRange.prevMonthDay, .flatpickr-day.selected.nextMonthDay, .flatpickr-day.startRange.nextMonthDay, .flatpickr-day.endRange.nextMonthDay {
            background: #667eea;
            border-color: #667eea;
        }

        /* BARRA LATERAL (SIDEBAR) */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100%;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item {
            padding: 15px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: 600;
        }

        /* CONTENIDO PRINCIPAL */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
        }

        /* TARJETAS DE ESTADÍSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-card[onclick]:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        /* FORMULARIO Y TABLA */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        h2 { color: #444; font-size: 1.2rem; }

        /* INPUTS MEJORADOS */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: 0.3s;
            background: #f9f9f9;
        }

        input:focus, textarea:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Input especial para fecha (readonly porque lo maneja el calendario) */
        input.flatpickr-input {
            background-color: white;
            cursor: pointer;
        }

        /* BOTONES */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            color: white;
        }
        
        .btn-primary { background: #667eea; }
        .btn-primary:hover { background: #5a6fd6; transform: translateY(-2px); }
        .btn-danger { background: #ff6b6b; }
        .btn-warning { background: #ffd93d; color: #333; }
        .btn-success { background: #51cf66; }
        .btn-secondary { background: #888; }

        /* TABLA */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; color: #888; font-size: 0.9rem; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #555; }
        tr:hover { background: #f8f9fa; }

        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            background: #e3f2fd;
            color: #2196f3;
        }

    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">
            <i class="fas fa-church"></i> Parroquia
        </div>
        <a href="#" class="menu-item active">
            <i class="fas fa-water"></i> Bautizos
        </a>
        <a href="#" class="menu-item">
            <i class="fas fa-ring"></i> Matrimonios
        </a>
        <div style="margin-top: auto;">
            <a href="#" class="menu-item">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <main class="main-content">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #667eea;">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <h3 id="total-count">0</h3>
                    <span style="color: #888; font-size: 0.9rem;">Total Registros</span>
                </div>
            </div>
            
            <div class="stat-card" onclick="irAlBuscador()" style="cursor: pointer; transition: transform 0.2s;">
                <div class="stat-icon" style="background: #ff6b6b;">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div>
                    <h3>Generar PDF</h3>
                    <span style="color: #888; font-size: 0.9rem;">Ir a búsqueda rápida ⬇</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-plus-circle" style="color:#667eea;"></i> Nuevo Registro</h2>
                <button class="btn btn-secondary" onclick="limpiarFormulario()" id="btn-cancelar" style="display:none;">Cancelar Edición</button>
            </div>
            
            <input type="hidden" id="bautizo-id">
            
            <div class="form-grid">
                <div>
                    <label style="font-size:0.8rem; color:#888; margin-bottom:5px; display:block;">CI / Documento</label>
                    <input type="text" id="ci" placeholder="Ej: 1234567" style="border-left: 4px solid #ffd93d;">
                </div>
                
                <div>
                    <label style="font-size:0.8rem; color:#888; margin-bottom:5px; display:block;">Fecha Bautizo</label>
                    <input type="text" id="fechaBautizo" placeholder="Selecciona una fecha...">
                </div>
                
                <input type="text" id="nombreBautizado" placeholder="Nombres del Bautizado">
                <input type="text" id="apellidoBautizado" placeholder="Apellidos del Bautizado">
                
                <input type="text" id="nombrePadre" placeholder="Nombre Padre">
                <input type="text" id="nombreMadre" placeholder="Nombre Madre">
                
                <input type="text" id="nombrePadrino" placeholder="Nombre Padrino">
                <input type="text" id="nombreMadrina" placeholder="Nombre Madrina">
            </div>
            
            <div style="margin-top: 15px;">
                <textarea id="observaciones" rows="2" placeholder="Observaciones adicionales..."></textarea>
            </div>

            <div style="margin-top: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="guardarBautizo()">
                    <i class="fas fa-save"></i> Guardar Registro
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-list"></i> Lista de Bautizos</h2>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="buscador" placeholder="Buscar por Nombre, Apellido o CI..." 
                           style="padding:8px; width:280px;" onkeyup="if(event.key==='Enter') cargarBautizos()">
                    
                    <button class="btn btn-primary" onclick="cargarBautizos()" title="Buscar">
                        <i class="fas fa-search"></i>
                    </button>
                    
                    <button class="btn btn-secondary" onclick="limpiarBuscador()" title="Limpiar filtro" style="background: #6c757d;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>CI</th>
                            <th>Bautizado</th>
                            <th>Fecha</th>
                            <th>Padres</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body"></tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        const API_URL = 'http://localhost:8080/api/bautizos';

        // INICIALIZAR EL CALENDARIO (Flatpickr)
        const calendario = flatpickr("#fechaBautizo", {
            locale: "es",           // Idioma español
            dateFormat: "Y-m-d",    // Formato para la Base de Datos
            altInput: true,         // Mostrar formato bonito al usuario
            altFormat: "j \\de F, Y", // Ej: 12 de Diciembre, 2025
            allowInput: true        // Permitir escribir a mano si se desea
        });

        window.onload = cargarBautizos;

        function irAlBuscador() {
            const buscador = document.getElementById('buscador');
            buscador.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setTimeout(() => buscador.focus(), 500);
            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Busca a una persona para imprimir', showConfirmButton: false, timer: 3000 });
        }

        async function cargarBautizos() {
            const termino = document.getElementById('buscador').value;
            let url = API_URL;
            if(termino) url += `?buscar=${encodeURIComponent(termino)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                document.getElementById('total-count').innerText = data.length;

                const tbody = document.getElementById('tabla-body');
                tbody.innerHTML = '';
                
                data.forEach(b => {
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="badge">${b.ci || 'S/N'}</span></td>
                            <td style="font-weight:600;">${b.nombreBautizado} ${b.apellidoBautizado}</td>
                            <td>${b.fechaBautizo || '-'}</td>
                            <td style="font-size:0.9rem;">${b.nombrePadre || ''} <br> ${b.nombreMadre || ''}</td>
                            <td>
                                <button class="btn btn-success" style="padding:5px 10px;" onclick="descargarPdf(${b.id})" title="PDF"><i class="fas fa-file-pdf"></i></button>
                                <button class="btn btn-warning" style="padding:5px 10px;" onclick="editar(${b.id})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" style="padding:5px 10px;" onclick="eliminar(${b.id})" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        async function guardarBautizo() {
            const id = document.getElementById('bautizo-id').value;
            const datos = {
                ci: document.getElementById('ci').value,
                nombreBautizado: document.getElementById('nombreBautizado').value,
                apellidoBautizado: document.getElementById('apellidoBautizado').value,
                // Leemos el valor directo del input (que flatpickr ya puso en formato Y-m-d)
                fechaBautizo: document.getElementById('fechaBautizo').value, 
                nombrePadre: document.getElementById('nombrePadre').value,
                nombreMadre: document.getElementById('nombreMadre').value,
                nombrePadrino: document.getElementById('nombrePadrino').value,
                nombreMadrina: document.getElementById('nombreMadrina').value,
                observaciones: document.getElementById('observaciones').value
            };

            if (!datos.ci || !datos.nombreBautizado) {
                Swal.fire('Atención', 'El CI y el Nombre son obligatorios', 'warning');
                return;
            }

            let url = API_URL;
            let metodo = 'POST';
            if (id) { url += `/${id}`; metodo = 'PUT'; }

            try {
                const res = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                if (res.ok) {
                    Swal.fire('¡Excelente!', 'Registro guardado correctamente', 'success');
                    limpiarFormulario();
                    cargarBautizos();
                } else {
                    const msg = await res.text();
                    Swal.fire('Error', msg, 'error');
                }
            } catch (e) { 
                Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
            }
        }

        async function eliminar(id) {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                text: "No podrás revertir esto",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            });

            if (result.isConfirmed) {
                await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                cargarBautizos();
                Swal.fire('Eliminado', 'El registro ha sido borrado.', 'success');
            }
        }

        async function editar(id) {
            const res = await fetch(`${API_URL}/${id}`);
            const b = await res.json();
            
            document.getElementById('bautizo-id').value = b.id;
            document.getElementById('ci').value = b.ci || '';
            document.getElementById('nombreBautizado').value = b.nombreBautizado;
            document.getElementById('apellidoBautizado').value = b.apellidoBautizado;
            
            // Actualizamos el calendario con la fecha que viene del servidor
            if(b.fechaBautizo) {
                calendario.setDate(b.fechaBautizo);
            } else {
                calendario.clear();
            }

            document.getElementById('nombrePadre').value = b.nombrePadre;
            document.getElementById('nombreMadre').value = b.nombreMadre;
            document.getElementById('nombrePadrino').value = b.nombrePadrino;
            document.getElementById('nombreMadrina').value = b.nombreMadrina;
            document.getElementById('observaciones').value = b.observaciones || '';

            document.getElementById('btn-cancelar').style.display = 'inline-block';
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        function limpiarFormulario() {
            document.querySelectorAll('input, textarea').forEach(i => i.value = '');
            // Limpiamos el calendario específicamente
            calendario.clear();
            
            document.getElementById('bautizo-id').value = '';
            document.getElementById('btn-cancelar').style.display = 'none';
        }

        // FUNCIÓN PARA LIMPIAR EL BUSCADOR
        function limpiarBuscador() {
            document.getElementById('buscador').value = ''; // Borra el texto
            cargarBautizos(); // Recarga la lista completa
            
            // Opcional: Poner el foco de nuevo en el input
            document.getElementById('buscador').focus();
        }

        function descargarPdf(id) { window.location.href = `${API_URL}/${id}/pdf`; }
    </script>

</body>
</html>